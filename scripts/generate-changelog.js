#!/usr/bin/env node

/**
 * Parses CHANGELOG.md and generates TypeScript data for the current version
 * Run: node scripts/generate-changelog.js
 */

import { readFileSync, writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = join(__dirname, '..');

// Read version from package.json
const packageJsonPath = join(rootDir, 'package.json');
const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf-8'));
const version = packageJson.version;

// Parse CHANGELOG.md for current version
const changelogPath = join(rootDir, 'CHANGELOG.md');
const changelog = readFileSync(changelogPath, 'utf-8');

function parseChangelog(content, targetVersion) {
    const lines = content.split('\n');
    const result = {
        version: targetVersion,
        date: '',
        sections: []
    };
    
    let inTargetVersion = false;
    let currentSection = null;
    
    for (const line of lines) {
        // Match version header: ## [0.0.2] - 2025-05-28
        const versionMatch = line.match(/^## \[([^\]]+)\](?: - (\d{4}-\d{2}-\d{2}))?/);
        if (versionMatch) {
            if (inTargetVersion) {
                // We've hit the next version, stop parsing
                break;
            }
            if (versionMatch[1] === targetVersion) {
                inTargetVersion = true;
                result.date = versionMatch[2] || '';
            }
            continue;
        }
        
        if (!inTargetVersion) continue;
        
        // Match section header: ### Added, ### Changed, etc.
        const sectionMatch = line.match(/^### (.+)/);
        if (sectionMatch) {
            currentSection = {
                title: sectionMatch[1],
                items: []
            };
            result.sections.push(currentSection);
            continue;
        }
        
        // Match list item: - Something
        const itemMatch = line.match(/^- (.+)/);
        if (itemMatch && currentSection) {
            currentSection.items.push(itemMatch[1]);
        }
    }
    
    return result;
}

const changelogData = parseChangelog(changelog, version);

if (changelogData.sections.length === 0) {
    console.warn(`⚠️  No changelog entry found for version ${version}`);
} else {
    console.log(`✅ Parsed changelog for v${version} (${changelogData.sections.length} sections)`);
}

// Generate TypeScript file
const changelogTsPath = join(rootDir, 'src', 'lib', 'changelog-data.ts');
const changelogTsContent = `// Auto-generated by scripts/generate-changelog.js - DO NOT EDIT
export interface ChangelogSection {
    title: string;
    items: string[];
}

export interface ChangelogData {
    version: string;
    date: string;
    sections: ChangelogSection[];
}

export const currentChangelog: ChangelogData = ${JSON.stringify(changelogData, null, 4)};
`;

writeFileSync(changelogTsPath, changelogTsContent);
console.log(`✅ Generated src/lib/changelog-data.ts`);
